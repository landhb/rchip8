<html>
  <style>
    canvas {
    	image-rendering: -moz-crisp-edges;    
    	image-rendering: -webkit-crisp-edges; 
    	image-rendering: pixelated;           
    }
    body {
	width: 512px;
        margin-left: auto;
	margin-right: auto;
    }
    h1 {
	text-align: center;
    }
    p {
	text-align: center;
    }
  </style>
  <head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type"/>
  </head>
  <body>
    <h1>Chip8 Emulator in Rust & Wasm</h1> 
    <br>
    <p>
    	Source code can be located <a href="https://github.com/landhb/rchip8">here</a>
    <p>
    <div class='screen'>
    	<canvas id='canvas' width='64' height='32'
    	style='transform: scale(8); transform-origin: top left'></canvas>
    </div>
    <!-- Note the usage of `type=module` here as this is an ES6 module -->
    <script type="module">
      const WIDTH = 64;
      const HEIGHT = 32;
      
      // Use ES module import syntax to import functionality from the module
      // that we have compiled.
      import init, { 
        load_program,      // Rust lib binary loader
        handle_key_event,  // Rust lib key up/key down event handler
        execute_cycle,     // Rust lib, execute a chip8 cycle - 500Hz
        update_display,    // Rust lib, write to display - 60Hz
	update_timers,     // Rust lib, update timers - 60Hz
      } from './pkg/rchip8_wasm.js';

      /**
       * Initialise the canvas
       */
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");
      ctx.fillStyle = "black";
      ctx.fillRect(0, 0, WIDTH, HEIGHT);


      /**
       * Key event callback
       */
      async function key_press_callback(e) {
        handle_key_event(e.keyCode, e.type);
      }

      /**
       * Display callback, redraw the screen 
       */
      async function display_callback() {
        const imageData = ctx.createImageData(WIDTH, HEIGHT);
        update_display(imageData.data);
        ctx.putImageData(imageData, 0, 0);
        window.requestAnimationFrame(display_callback);
	update_timers();
      };


      /**
       * Main entry point
       */
      async function run() {
        
	// Load & init wasm module
        await init();

        /**
         * Load the program into memory
         */
        const res = await fetch("./roms/WIPEOFF");
        const buffer = await res.arrayBuffer();
        let prog = new Uint8Array(buffer);
        const result = load_program(prog);

        /**
         * Setup keyboard event listeners
         */
        document.addEventListener('keyup', key_press_callback);
        document.addEventListener('keydown', key_press_callback);

        /**
         * Setup clock speed, Chip8 clock speed is 500HZ 
         * which is 2 milliseconds between ticks
         */
        window.setInterval(execute_cycle, 2);

        /**
         * Begin redrawing the screen
         */
        window.requestAnimationFrame(display_callback);
       
      }
      run();
    </script>
  </body>
</html>
